<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boussole</title>
</head>
<body>
  <h1>Test Boussole</h1>
  <input type="text" id="lieu" placeholder="Lieu" />
  <button id="startBtn">Autoriser accès capteurs</button>
  <p id="azimut">--°</p>
  <p id="message"></p>

  <script>
    let azimut = null;

    function handleOrientation(e) {
      if (e.alpha != null) {
        azimut = Math.round((360 - e.alpha) % 360);
        document.getElementById('azimut').textContent = azimut + "°";
      }
    }

    function start() {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation);
            setInterval(sendAzimuth, 10000);
          }
        }).catch(console.error);
      } else {
        window.addEventListener('deviceorientation', handleOrientation);
        setInterval(sendAzimuth, 10000);
      }
    }

    function sendAzimuth() {
      const lieu = document.getElementById('lieu').value.trim();
      if (!lieu || azimut === null) return;

      fetch('https://emercier.synology.me/insert_azimuth_iphone.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `azimuth=${azimut}&lieu=${encodeURIComponent(lieu)}`
      })
      .then(res => res.text())
      .then(txt => document.getElementById('message').textContent = txt)
      .catch(err => document.getElementById('message').textContent = "Erreur : " + err);
    }

    document.getElementById('startBtn').addEventListener('click', start);
  </script>
</body>
</html>
